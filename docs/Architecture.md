### **架构设计文档：Word MCP服务 (COM接口版)**

**版本:** 3.1
**核心理念:** **奥卡姆剃刀 (Ockham's Razor)** - 如无必要，勿增实体。
**日期:** 2025年8月29日

---

### **1. 概述**

#### **1.1. 目标**
本服务旨在为AI大语言模型提供一个**简洁、强大且可靠**的接口，用于对本地Microsoft Word文档进行精确的自动化操作。服务遵循模型上下文协议 (MCP) 规范，通过一系列简单直接的工具 (Tools) 暴露Word的核心功能。

#### **1.2. 设计哲学**
我们严格遵循**奥卡姆剃刀**原则：
*   **简洁性优于完备性:** 优先实现最常用、最高价值的功能。避免为不常见的边缘情况增加复杂性。
*   **实用主义:** 架构和工具的设计以能用、好用为首要目标。
*   **关注点分离:** 将复杂的系统分解为简单、独立的组件，每个组件只做一件事。

---

### **2. 核心架构**

系统由四个高度解耦的组件构成，确保了逻辑的清晰和未来的可扩展性。

#### **2.1. 架构图**

```
+-------------------------------------------------------------------------+
|                      AI / MCP Client (e.g., LLM Agent)                  |
+---------------------------------+---------------------------------------+
                                  |
                                  | (MCP Tool Call)
                                  v
+-------------------------------------------------------------------------+
| **1. MCP服务层 (`app.py`)**                                             |
| (定义工具, 管理会话, 翻译AI意图)                                        |
| e.g., @mcp.tool() def get_text(ctx, locator): ...                       |
+---------------------------------+---------------------------------------+
                                  |
                                  | (Calls Selector & Selection)
                                  v
+-------------------------------------------------------------------------+
| **2. 选择器引擎 (`selector.py`)**                                       |
| (根据 "Locator" 对象, 精确查找文档中的一个或多个元素)                   |
+---------------------------------+---------------------------------------+
                                  |
                                  v
+-------------------------------------------------------------------------+
| **3. 选择集抽象 (`selection.py`)**                                      |
| (为找到的元素提供统一的原子操作接口, 如 .delete(), .apply_format())     |
+---------------------------------+---------------------------------------+
                                  |
                                  v
+-------------------------------------------------------------------------+
| **4. 操作层 (`operations/`)**                                           |
| (提供底层文档操作实现，如文本格式化、元素操作、注释操作等)              |
| - `object_operations.py`: 元素级操作                                   |
| - `text_formatting.py`: 文本格式化操作                                  |
| - `comment_operations.py`: 注释操作                                     |
| - `document_operations.py`: 文档级操作                                  |
+---------------------------------+---------------------------------------+
                                  |
                                  v
+-------------------------------------------------------------------------+
| **5. COM后端 (`com_backend/`)**                                         |
| (与Microsoft Word COM接口交互的底层实现)                                |
+-------------------------------------------------------------------------+
```

#### **2.2. 操作层 (Operations Layer)**

操作层是系统的核心组件之一，负责提供底层文档操作的具体实现。该层被设计为独立的模块集合，每个模块专注于特定类型的操作。

##### **2.2.1. 模块结构**

1. **object_operations.py** - 元素级操作
   - 提供对单个文档元素的操作，如插入文本、替换文本、设置图片颜色类型、添加题注等
   - 所有函数采用统一的参数顺序，以文档对象作为第一个参数
   - 使用统一的错误处理装饰器

2. **text_formatting.py** - 文本格式化操作
   - 提供文本格式化功能，如设置字体、段落样式、对齐方式等
   - 所有函数具有完整的类型注解和文档字符串
   - 使用统一的错误处理机制

3. **comment_operations.py** - 注释操作
   - 提供对文档注释的操作，如添加、删除、编辑注释等
   - 采用一致的函数签名和错误处理方式

4. **document_operations.py** - 文档级操作
   - 提供文档级别的操作，如获取所有段落、查找和替换文本等
   - 统一使用日志记录替代print语句

##### **2.2.2. 设计原则**

1. **一致性** - 所有操作函数遵循相同的设计模式和编码规范
2. **可维护性** - 清晰的文档字符串和类型注解使代码易于理解和维护
3. **错误处理** - 统一的错误处理机制确保系统健壮性
4. **可测试性** - 独立的模块设计便于单元测试和集成测试

---

### **3. 数据流**

1. **工具调用** - AI客户端通过MCP协议调用特定工具
2. **上下文管理** - MCP服务层解析请求并管理会话上下文
3. **元素选择** - 选择器引擎根据定位器查找文档元素
4. **操作执行** - 选择集抽象调用操作层执行具体操作
5. **COM交互** - 操作层通过COM后端与Word应用程序交互
6. **结果返回** - 操作结果逐层返回给AI客户端

---

### **4. 错误处理**

系统采用分层错误处理机制：
- **COM层** - 捕获并转换COM接口错误
- **操作层** - 统一处理操作相关错误
- **工具层** - 提供用户友好的错误信息
- **MCP层** - 按照MCP协议格式化错误响应

---

### **5. 扩展性**

系统设计支持以下扩展方式：
- **新增操作** - 在操作层添加新功能模块
- **新增工具** - 在MCP服务层定义新工具接口
- **增强选择器** - 扩展选择器引擎支持更多元素类型和过滤器