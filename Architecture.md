### **架构设计文档：Word MCP服务 (COM接口版)**

**版本:** 3.0
**核心理念:** **奥卡姆剃刀 (Ockham's Razor)** - 如无必要，勿增实体。
**日期:** 2025年8月17日

---

### **1. 概述**

#### **1.1. 目标**
本服务旨在为AI大语言模型提供一个**简洁、强大且可靠**的接口，用于对本地Microsoft Word文档进行精确的自动化操作。服务遵循模型上下文协议 (MCP) 规范，通过一系列简单直接的工具 (Tools) 暴露Word的核心功能。

#### **1.2. 设计哲学**
我们严格遵循**奥卡姆剃刀**原则：
*   **简洁性优于完备性:** 优先实现最常用、最高价值的功能。避免为不常见的边缘情况增加复杂性。
*   **实用主义:** 架构和工具的设计以能用、好用为首要目标。
*   **关注点分离:** 将复杂的系统分解为简单、独立的组件，每个组件只做一件事。

---

### **2. 核心架构**

系统由四个高度解耦的组件构成，确保了逻辑的清晰和未来的可扩展性。

#### **2.1. 架构图**

```
+-------------------------------------------------------------------------+
|                      AI / MCP Client (e.g., LLM Agent)                  |
+---------------------------------+---------------------------------------+
                                  |
                                  | (MCP Tool Call)
                                  v
+-------------------------------------------------------------------------+
| **1. MCP服务层 (`app.py`)**                                             |
| (定义工具, 管理会话, 翻译AI意图)                                        |
| e.g., @mcp.tool() def get_text(ctx, locator): ...                       |
+---------------------------------+---------------------------------------+
                                  |
                                  | (Calls Selector & Selection)
                                  v
+-------------------------------------------------------------------------+
| **2. 选择器引擎 (`selector.py`)**                                       |
| (根据 "Locator" 对象, 精确查找文档中的一个或多个元素)                   |
+---------------------------------+---------------------------------------+
                                  |
                                  v
+-------------------------------------------------------------------------+
| **3. 选择集抽象 (`selection.py`)**                                      |
| (为找到的元素提供统一的原子操作接口, 如 .delete(), .apply_format())     |
+---------------------------------+---------------------------------------+
                                  |
                                  v
+-------------------------------------------------------------------------+
| **4. COM后端 (`com_backend.py`)**                                       |
| (封装所有底层的 pywin32 调用, 直接与Word应用通信)                       |
+---------------------------------+---------------------------------------+
                                  |
                                  v
+-------------------------------------------------------------------------+
|                      Microsoft Word Application (COM Server)            |
+-------------------------------------------------------------------------+
```

---

### **3. 当前核心能力**

项目已经具备稳定且强大的核心能力，足以支撑大部分常见的文档自动化任务。

#### **3.1. `Locator` 查询语言**
这是实现精确操作的基石。它允许AI以声明方式定位文档元素。

*   **支持的目标类型:** `paragraph`, `heading`, `table`, `cell`, `run`
*   **支持的过滤器:**
    *   内容: `contains_text`, `text_matches_regex`
    *   格式: `is_bold`, `style`, `is_list_item`
    *   位置: `index_in_parent`, `row_index`, `column_index`
*   **支持的关系:** `first_occurrence_after`, `all_occurrences_within`

#### **3.2. 已实现的工具 (Tools)**
*   **文档管理:** `open_document`, `shutdown_word`
*   **内容读取:** `get_text`, `get_document_structure` (读取标题大纲)
*   **内容写入:** `insert_paragraph`, `replace_text`, `set_cell_value`
*   **内容创建:** `create_table`, `create_bulleted_list`
*   **格式化:** `apply_format` (支持粗体, 对齐等)
*   **删除:** `delete_element`
*   **高级编辑:** `accept_all_changes`

#### **3.3. 健壮性**
*   **自定义异常:** 定义了 `ElementNotFoundError`, `AmbiguousLocatorError` 等异常，为AI提供清晰的失败反馈。
*   **COM资源管理:** 通过上下文管理器 (`with` 语句) 确保Word进程和文档对象被可靠地创建和释放。

---

### **4. 部署要求**

1.  **操作系统:** Windows
2.  **软件依赖:** Microsoft Office Word
3.  **Python库:** `mcp[cli]>=0.1.0`, `pywin32`
